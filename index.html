<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[pWR] Alliance Duel Weekly Leaderboard</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- Other Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
/* =================================================================
   LAST WAR: SURVIVAL THEME - POST-APOCALYPTIC ZOMBIE SURVIVAL STYLE
   Replace the <style> section in your dashboard with this CSS
   ================================================================= */

   @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Rajdhani:wght@400;600;700&family=Teko:wght@400;600;700&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; }

/* ===== RTL SUPPORT ===== */
[dir="rtl"] {
    text-align: right;
}

[dir="rtl"] .header {
    direction: rtl;
}

[dir="rtl"] .week-controls {
    direction: rtl;
}

[dir="rtl"] .control-buttons {
    direction: rtl;
}

[dir="rtl"] .data-table {
    direction: rtl;
}

[dir="rtl"] .modal-content {
    direction: rtl;
    text-align: right;
}

[dir="rtl"] .search-bar {
    text-align: right;
}

[dir="rtl"] #languageToggle {
    left: 20px;
    right: auto;
}

/* ===== APOCALYPTIC BACKGROUND ===== */
body {
    font-family: 'Rajdhani', sans-serif;
    background: linear-gradient(135deg, #0d0d0d 0%, #1a1410 50%, #1f1a15 100%);
    background-image: 
        radial-gradient(ellipse at top, rgba(139, 69, 0, 0.1), transparent),
        radial-gradient(ellipse at bottom, rgba(200, 50, 0, 0.05), transparent);
    color: #d4d4d4;
    min-height: 100vh;
    padding: 20px;
}

.dashboard-container { max-width: 1600px; margin: 0 auto; }

/* ===== MILITARY HEADER ===== */
.header {
    text-align: center;
    margin-bottom: 30px;
    padding: 30px 20px;
    background: linear-gradient(135deg, rgba(40, 30, 20, 0.9), rgba(30, 25, 20, 0.9));
    border: 3px solid #8b5a00;
    border-radius: 10px;
    box-shadow: 0 0 40px rgba(200, 100, 0, 0.3), inset 0 0 20px rgba(0, 0, 0, 0.5);
    position: relative;
}

/* Scanline Effect */
.header::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 0, 0, 0.1) 2px,
        rgba(0, 0, 0, 0.1) 4px
    );
    pointer-events: none;
}

/* Alliance Logo - Burning Effect */
.alliance-logo {
    font-family: 'Oswald', sans-serif;
    font-size: 4rem;
    font-weight: 700;
    color: #ff6600;
    text-shadow: 
        0 0 10px #ff6600,
        0 0 20px #cc3300,
        2px 2px 4px #000,
        -2px -2px 4px #000;
    padding: 20px;
    border: 3px solid #8b5a00;
    background: linear-gradient(135deg, rgba(60, 40, 20, 0.8), rgba(40, 30, 15, 0.8));
    border-radius: 10px;
    display: inline-block;
    animation: flickerGlow 3s infinite;
    letter-spacing: 8px;
}

@keyframes flickerGlow {
    0%, 100% { 
        box-shadow: 0 0 20px rgba(255, 102, 0, 0.5), 
                   inset 0 0 10px rgba(255, 102, 0, 0.2);
    }
    50% { 
        box-shadow: 0 0 30px rgba(255, 102, 0, 0.8), 
                   inset 0 0 15px rgba(255, 102, 0, 0.3);
    }
}

.header h1 {
    font-family: 'Oswald', sans-serif;
    font-size: 2.5rem;
    font-weight: 700;
    color: #ffaa00;
    text-shadow: 2px 2px 4px #000, 0 0 10px #ff6600;
    margin: 15px 0 5px 0;
    letter-spacing: 3px;
}

.alliance-name {
    font-family: 'Teko', sans-serif;
    font-size: 1.6rem;
    color: #ff9933;
    margin: 8px 0;
    letter-spacing: 4px;
    text-transform: uppercase;
    text-shadow: 1px 1px 2px #000;
}

.event-subtitle {
    font-size: 1.1rem;
    color: #cc6633;
    margin: 5px 0;
    letter-spacing: 2px;
    font-weight: 600;
    text-shadow: 1px 1px 2px #000;
}

/* ===== MILITARY CONTROLS ===== */
.week-controls {
    display: flex;
    justify-content: space-between;
    gap: 15px;
    margin-bottom: 25px;
    padding: 20px;
    background: linear-gradient(135deg, rgba(40, 35, 25, 0.9), rgba(30, 25, 20, 0.9));
    border: 2px solid #6b5a3d;
    border-radius: 8px;
    flex-wrap: wrap;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
}

.week-selector { display: flex; gap: 10px; flex-wrap: wrap; }

.week-btn, .action-btn {
    padding: 12px 20px;
    background: linear-gradient(135deg, #3a3020, #2a2515);
    border: 2px solid #6b5a3d;
    border-radius: 6px;
    color: #d4a765;
    font-family: 'Teko', sans-serif;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
}

.week-btn:hover, .action-btn:hover {
    border-color: #ff9933;
    color: #ffcc66;
    box-shadow: 0 0 15px rgba(255, 153, 51, 0.4);
    transform: translateY(-2px);
    background: linear-gradient(135deg, #4a4030, #3a3025);
}

.week-btn.active {
    background: linear-gradient(135deg, #ff6600, #cc5200);
    border-color: #ff9933;
    color: #ffffff;
    box-shadow: 0 0 20px rgba(255, 102, 0, 0.6);
    text-shadow: 0 0 5px #000;
}

.upload-btn {
    padding: 12px 25px;
    background: linear-gradient(135deg, #cc5200, #993d00);
    border: 2px solid #ff6600;
    border-radius: 6px;
    color: #ffffff;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(255, 102, 0, 0.3);
    font-family: 'Teko', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 1px;
}

.upload-btn:hover {
    background: linear-gradient(135deg, #ff6600, #cc5200);
    box-shadow: 0 6px 20px rgba(255, 102, 0, 0.5);
    transform: translateY(-2px);
}

.control-buttons { display: flex; gap: 10px; flex-wrap: wrap; }

/* ===== RESOURCE CARDS (KPIs) ===== */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.kpi-card {
    background: linear-gradient(135deg, rgba(50, 40, 25, 0.9), rgba(35, 28, 18, 0.9));
    border: 2px solid #6b5a3d;
    border-left: 4px solid #ff6600;
    border-radius: 8px;
    padding: 25px;
    text-align: center;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
}

.kpi-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(255, 102, 0, 0.3);
    border-color: #ff9933;
}

.kpi-label {
    font-size: 0.9rem;
    color: #997755;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 10px;
    font-weight: 600;
}

.kpi-value {
    font-family: 'Oswald', sans-serif;
    font-size: 2.2rem;
    font-weight: 700;
    color: #ffaa33;
    text-shadow: 0 0 10px rgba(255, 170, 51, 0.5), 2px 2px 4px #000;
}

.kpi-subtext {
    font-size: 0.85rem;
    color: #7a6a50;
    margin-top: 5px;
}

/* ===== COMBAT STATS ===== */
.movement-section { margin: 30px 0; }

.section-title {
    font-family: 'Oswald', sans-serif;
    font-size: 1.8rem;
    text-align: center;
    color: #ffaa33;
    text-shadow: 2px 2px 4px #000, 0 0 10px #ff6600;
    margin-bottom: 25px;
    text-transform: uppercase;
    letter-spacing: 3px;
}

.movement-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.movement-card {
    background: linear-gradient(135deg, rgba(40, 35, 25, 0.9), rgba(30, 25, 20, 0.9));
    border: 2px solid #6b5a3d;
    border-radius: 8px;
    padding: 25px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
}

.movement-icon { font-size: 3rem; margin-bottom: 10px; filter: drop-shadow(2px 2px 4px #000); }
.movement-title { font-size: 0.9rem; color: #997755; text-transform: uppercase; margin-bottom: 10px; font-weight: 600; }
.movement-player { font-family: 'Oswald', sans-serif; font-size: 1.3rem; color: #ffaa33; margin-bottom: 5px; text-shadow: 1px 1px 2px #000; }
.movement-stats { font-size: 0.9rem; color: #7a6a50; }

/* ===== CHARTS ===== */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.chart-card {
    background: linear-gradient(135deg, rgba(40, 35, 25, 0.9), rgba(30, 25, 20, 0.9));
    border: 2px solid #6b5a3d;
    border-radius: 8px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
}

.chart-title {
    font-family: 'Oswald', sans-serif;
    font-size: 1.2rem;
    color: #ffaa33;
    margin-bottom: 20px;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 1px 1px 2px #000;
}

/* ===== DIVISION SYSTEM ===== */
.division-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.division-card {
    background: linear-gradient(135deg, rgba(40, 35, 25, 0.9), rgba(30, 25, 20, 0.9));
    border: 2px solid #6b5a3d;
    border-radius: 8px;
    padding: 25px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
}

.division-card.elite { 
    border-color: #d4af37; 
    border-width: 3px;
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
}
.division-card.master { 
    border-color: #99cc33;
    box-shadow: 0 0 15px rgba(153, 204, 51, 0.2);
}
.division-card.warrior { 
    border-color: #cc6633;
    box-shadow: 0 0 15px rgba(204, 102, 51, 0.2);
}

.division-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.division-icon { font-size: 2rem; filter: drop-shadow(2px 2px 3px #000); }
.division-name { font-family: 'Oswald', sans-serif; font-size: 1.2rem; color: #ffcc66; flex: 1; margin: 0 10px; letter-spacing: 1px; }
.division-req { font-size: 0.85rem; color: #997755; }
.division-count { font-size: 1.1rem; color: #ffaa33; margin-bottom: 10px; font-weight: 600; }
.division-players { font-size: 0.9rem; color: #9a8970; line-height: 1.6; }

/* ===== LEADERBOARD TABLE ===== */
.table-container {
    background: linear-gradient(135deg, rgba(40, 35, 25, 0.9), rgba(30, 25, 20, 0.9));
    border: 2px solid #6b5a3d;
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
}

.search-bar {
    width: 100%;
    padding: 15px 20px;
    margin-bottom: 20px;
    background: rgba(20, 18, 15, 0.8);
    border: 2px solid #6b5a3d;
    border-radius: 6px;
    color: #d4d4d4;
    font-size: 1rem;
    font-family: 'Rajdhani', sans-serif;
}

.search-bar:focus {
    outline: none;
    border-color: #ff9933;
    box-shadow: 0 0 15px rgba(255, 153, 51, 0.3);
}

.table-wrapper {
    max-height: 600px;
    overflow-y: auto;
    border-radius: 8px;
}

.table-wrapper::-webkit-scrollbar { width: 12px; }
.table-wrapper::-webkit-scrollbar-track { background: rgba(20, 18, 15, 0.8); border-radius: 8px; }
.table-wrapper::-webkit-scrollbar-thumb { 
    background: linear-gradient(135deg, #ff6600, #cc5200); 
    border-radius: 8px;
    border: 2px solid rgba(20, 18, 15, 0.8);
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background: linear-gradient(135deg, #ff6600, #cc5200);
}

.data-table th {
    padding: 15px;
    text-align: left;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.9rem;
    color: #ffffff;
    text-shadow: 1px 1px 2px #000;
    font-family: 'Teko', sans-serif;
    letter-spacing: 1px;
}

.data-table tbody tr {
    border-bottom: 1px solid rgba(107, 90, 61, 0.3);
    transition: all 0.3s ease;
}

.data-table tbody tr:hover {
    background: rgba(255, 102, 0, 0.1);
}

.data-table td {
    padding: 12px 15px;
    color: #c4b5a0;
}

/* ===== RANK BADGES - MILITARY STYLE ===== */
.rank-badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 4px;
    font-weight: 700;
    font-size: 0.85rem;
    font-family: 'Oswald', sans-serif;
    letter-spacing: 1px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
}

.rank-1 { 
    background: linear-gradient(135deg, #d4af37, #f4d03f); 
    color: #000;
    box-shadow: 0 0 15px rgba(212, 175, 55, 0.6);
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
}
.rank-2 { 
    background: linear-gradient(135deg, #c0c0c0, #e8e8e8); 
    color: #000;
    box-shadow: 0 0 12px rgba(192, 192, 192, 0.5);
}
.rank-3 { 
    background: linear-gradient(135deg, #cd7f32, #e6a157); 
    color: #000;
    box-shadow: 0 0 12px rgba(205, 127, 50, 0.5);
}
.rank-top10 { background: rgba(255, 153, 51, 0.3); color: #ffaa33; border: 1px solid #ff9933; }
.rank-default { background: rgba(80, 70, 60, 0.3); color: #9a8970; border: 1px solid #6b5a3d; }

.rank-movement {
    display: inline-flex;
    align-items: center;
    font-weight: 700;
    font-size: 1.1rem;
}

.rank-movement.up { color: #99cc33; text-shadow: 0 0 5px #99cc33; }
.rank-movement.down { color: #cc3300; text-shadow: 0 0 5px #cc3300; }
.rank-movement.same { color: #7a6a50; }

.achievement-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    margin: 2px;
    background: rgba(255, 153, 51, 0.2);
    border: 1px solid rgba(255, 153, 51, 0.5);
}

.view-profile-btn {
    padding: 6px 12px;
    background: rgba(204, 82, 0, 0.4);
    border: 1px solid #cc5200;
    border-radius: 4px;
    color: #ffaa33;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Teko', sans-serif;
}

.view-profile-btn:hover {
    background: rgba(255, 102, 0, 0.6);
    color: #ffffff;
    box-shadow: 0 0 10px rgba(255, 102, 0, 0.4);
}

/* ===== FOOTER ===== */
.footer {
    text-align: center;
    margin-top: 40px;
    padding: 30px 20px;
    background: linear-gradient(135deg, rgba(40, 35, 25, 0.9), rgba(30, 25, 20, 0.9));
    border: 2px solid #6b5a3d;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
}

.creator-tag {
    font-family: 'Oswald', sans-serif;
    font-weight: 700;
    color: #ff9933;
    font-size: 1.3rem;
    letter-spacing: 2px;
    text-shadow: 0 0 10px rgba(255, 153, 51, 0.5), 2px 2px 4px #000;
}

/* ===== MODAL ===== */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(10px);
}

.modal-content {
    background: linear-gradient(135deg, rgba(40, 35, 25, 0.95), rgba(30, 25, 20, 0.95));
    margin: 5% auto;
    padding: 0;
    border: 3px solid #6b5a3d;
    border-radius: 8px;
    width: 90%;
    max-width: 900px;
    box-shadow: 0 10px 50px rgba(255, 102, 0, 0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    padding: 25px;
    background: linear-gradient(135deg, #ff6600, #cc5200);
    border-radius: 5px 5px 0 0;
}

.modal-header h2 {
    font-family: 'Oswald', sans-serif;
    color: #ffffff;
    margin: 0;
    text-shadow: 2px 2px 4px #000;
}

.modal-close {
    color: #ffffff;
    font-size: 2rem;
    cursor: pointer;
    text-shadow: 2px 2px 4px #000;
}

.modal-body { padding: 25px; }

.profile-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.profile-stat {
    background: rgba(20, 18, 15, 0.8);
    border: 2px solid #6b5a3d;
    border-radius: 6px;
    padding: 15px;
    text-align: center;
}

.stat-label { font-size: 0.85rem; color: #997755; margin-bottom: 8px; }
.stat-value { font-family: 'Oswald', sans-serif; font-size: 1.5rem; color: #ffaa33; font-weight: 700; text-shadow: 0 0 8px rgba(255, 170, 51, 0.4); }

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .header h1 { font-size: 1.8rem; }
    .alliance-logo { font-size: 2.5rem; padding: 15px; }
    .charts-grid, .kpi-grid { grid-template-columns: 1fr; }
    .week-controls { flex-direction: column; }
}</style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <div style="position: absolute; top: 20px; right: 20px;">
                <button class="action-btn" id="languageToggle" style="font-size: 0.9rem; padding: 8px 15px;">
                    üåê ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
                </button>
            </div>
            <div class="alliance-logo">pWR</div>
            <h1 data-i18n="header.title">‚öîÔ∏è ALLIANCE DUEL LEADERBOARD ‚öîÔ∏è</h1>
            <p class="alliance-name" data-i18n="header.alliance">[pWR] POWEr Alliance</p>
            <p class="event-subtitle" data-i18n="header.event">Weekly Alliance Duel Event</p>
        </div>

        <!-- Week Controls -->
        <div class="week-controls">
            <div class="week-selector" id="weekSelector"></div>
            <div class="control-buttons">
                <label for="csvUpload" class="upload-btn" id="uploadBtn" data-i18n="buttons.upload">
                    üì§ Upload Week Data
                    <input type="file" id="csvUpload" accept=".csv" style="display: none;">
                </label>
                <button class="action-btn" id="signInOutBtn" data-i18n="buttons.signIn">üîê Sign In</button>
                <button class="action-btn" id="refreshDataBtn" data-i18n="buttons.refresh">üîÑ Refresh Data</button>
                <button class="action-btn" id="exportPdfBtn" data-i18n="buttons.exportPdf">üìÑ Export PDF</button>
                <button class="action-btn" id="exportCsvBtn" data-i18n="buttons.exportCsv">üíæ Export CSV</button>
                <button class="action-btn" id="shareBtn" data-i18n="buttons.screenshot">üì∏ Screenshot</button>
            </div>
        </div>

        <!-- KPIs -->
        <div class="kpi-grid" id="kpiGrid"></div>

        <!-- Movement Highlights -->
        <div class="movement-section" id="movementSection" style="display: none;">
            <h2 class="section-title">üìà Weekly Movement Highlights</h2>
            <div class="movement-grid">
                <div class="movement-card">
                    <div class="movement-icon">üöÄ</div>
                    <div class="movement-title">Biggest Climber</div>
                    <div class="movement-player" id="biggestClimber">-</div>
                    <div class="movement-stats" id="climberStats">-</div>
                </div>
                <div class="movement-card">
                    <div class="movement-icon">üìâ</div>
                    <div class="movement-title">Biggest Drop</div>
                    <div class="movement-player" id="biggestFaller">-</div>
                    <div class="movement-stats" id="fallerStats">-</div>
                </div>
                <div class="movement-card">
                    <div class="movement-icon">üëë</div>
                    <div class="movement-title">Weekly MVP</div>
                    <div class="movement-player" id="weeklyMvp">-</div>
                    <div class="movement-stats" id="mvpStats">-</div>
                </div>
                <div class="movement-card">
                    <div class="movement-icon">üî•</div>
                    <div class="movement-title">Top Streak</div>
                    <div class="movement-player" id="topStreak">-</div>
                    <div class="movement-stats" id="streakStats">-</div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3 class="chart-title">üèÜ Top 10 Champions</h3>
                <canvas id="barChart"></canvas>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">üìä Score Distribution</h3>
                <canvas id="pieChart"></canvas>
            </div>
        </div>

        <!-- Performance Charts -->
        <div class="performance-section">
            <h2 class="section-title">üìà Performance Analysis</h2>
            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">üî• Top 20 Performance</h3>
                    <canvas id="topPerformanceChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">üìâ Bottom 20 Performance</h3>
                    <canvas id="bottomPerformanceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Division System -->
        <div class="performance-section">
            <h2 class="section-title">üèÜ Division Rankings</h2>
            <div class="division-grid">
                <div class="division-card elite">
                    <div class="division-header">
                        <span class="division-icon">üëë</span>
                        <span class="division-name">Elite Division</span>
                        <span class="division-req">&gt;100M</span>
                    </div>
                    <div class="division-count" id="eliteDivisionCount">0 Players</div>
                    <div class="division-players" id="eliteDivisionPlayers"></div>
                </div>
                <div class="division-card master">
                    <div class="division-header">
                        <span class="division-icon">‚öîÔ∏è</span>
                        <span class="division-name">Master Division</span>
                        <span class="division-req">50M-100M</span>
                    </div>
                    <div class="division-count" id="masterDivisionCount">0 Players</div>
                    <div class="division-players" id="masterDivisionPlayers"></div>
                </div>
                <div class="division-card warrior">
                    <div class="division-header">
                        <span class="division-icon">üõ°Ô∏è</span>
                        <span class="division-name">Warrior Division</span>
                        <span class="division-req">&lt;50M</span>
                    </div>
                    <div class="division-count" id="warriorDivisionCount">0 Players</div>
                    <div class="division-players" id="warriorDivisionPlayers"></div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-container">
            <h3 class="chart-title">üìã Complete Leaderboard</h3>
            <input type="text" id="searchBar" class="search-bar" placeholder="üîç Search player name...">
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th data-i18n="table.rank">Rank</th>
                            <th data-i18n="table.movement">Movement</th>
                            <th data-i18n="table.playerName">Player Name</th>
                            <th data-i18n="table.points">Points</th>
                            <th data-i18n="table.achievements">Achievements</th>
                            <th data-i18n="table.division">Division</th>
                            <th data-i18n="table.actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Player Modal -->
        <div id="playerModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalPlayerName">Player Profile</h2>
                    <span class="modal-close" id="closeModal">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="profile-stats">
                        <div class="profile-stat">
                            <div class="stat-label">Current Rank</div>
                            <div class="stat-value" id="modalRank">-</div>
                        </div>
                        <div class="profile-stat">
                            <div class="stat-label">Total Points</div>
                            <div class="stat-value" id="modalPoints">-</div>
                        </div>
                        <div class="profile-stat">
                            <div class="stat-label">Division</div>
                            <div class="stat-value" id="modalDivision">-</div>
                        </div>
                    </div>
                    <div>
                        <h3 style="color: #8b45ff; margin-bottom: 15px;">Weekly Performance History</h3>
                        <canvas id="playerHistoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Player Modal -->
        <div id="editPlayerModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2>‚úèÔ∏è EDIT PLAYER</h2>
                    <span class="modal-close" id="closeEditModal">&times;</span>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editPlayerOriginalName">
                    <input type="hidden" id="editPlayerOriginalRank">
                    
                    <div style="margin-bottom: 20px;">
                        <label style="color: #997755; display: block; margin-bottom: 8px; font-weight: 600;">Player Name:</label>
                        <input type="text" id="editPlayerName" class="search-bar" style="margin-bottom: 15px;">
                        
                        <label style="color: #997755; display: block; margin-bottom: 8px; font-weight: 600;">Rank:</label>
                        <input type="number" id="editPlayerRank" class="search-bar" min="1" style="margin-bottom: 15px;">
                        
                        <label style="color: #997755; display: block; margin-bottom: 8px; font-weight: 600;">Points:</label>
                        <input type="text" id="editPlayerPoints" class="search-bar" placeholder="Enter points (e.g., 254714950)">
                    </div>
                    
                    <button class="upload-btn" id="saveEditPlayerBtn" style="width: 100%; margin-bottom: 10px;">
                        üíæ SAVE CHANGES
                    </button>
                    
                    <div id="editPlayerStatus" style="text-align: center; color: #ffaa33; margin-top: 10px; font-weight: 600;"></div>
                </div>
            </div>
        </div>

        <!-- Add Player Modal -->
        <div id="addPlayerModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2>‚ûï ADD NEW PLAYER</h2>
                    <span class="modal-close" id="closeAddModal">&times;</span>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 20px;">
                        <label style="color: #997755; display: block; margin-bottom: 8px; font-weight: 600;">Player Name:</label>
                        <input type="text" id="addPlayerName" class="search-bar" style="margin-bottom: 15px;" placeholder="Enter player name">
                        
                        <label style="color: #997755; display: block; margin-bottom: 8px; font-weight: 600;">Rank:</label>
                        <input type="number" id="addPlayerRank" class="search-bar" min="1" style="margin-bottom: 15px;" placeholder="Enter rank">
                        
                        <label style="color: #997755; display: block; margin-bottom: 8px; font-weight: 600;">Points:</label>
                        <input type="text" id="addPlayerPoints" class="search-bar" placeholder="Enter points (e.g., 254714950)">
                    </div>
                    
                    <button class="upload-btn" id="saveAddPlayerBtn" style="width: 100%; margin-bottom: 10px;">
                        ‚ûï ADD PLAYER
                    </button>
                    
                    <div id="addPlayerStatus" style="text-align: center; color: #ffaa33; margin-top: 10px; font-weight: 600;"></div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Created by: <span class="creator-tag">#1918 [pWR] DeFOUR</span></p>
            <p style="font-size: 0.9rem; color: #808080; margin-top: 5px;">Elite Alliance Dashboard System</p>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        
        const firebaseConfig = {
          apiKey: "AIzaSyD7GiyI6DhBr_AYW8y_Rreyos5TLUazn-Q",
          authDomain: "pwr-alliance-leaderboard-17775.firebaseapp.com",
          databaseURL: "https://pwr-alliance-leaderboard-17775-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "pwr-alliance-leaderboard-17775",
          storageBucket: "pwr-alliance-leaderboard-17775.firebasestorage.app",
          messagingSenderId: "938865791588",
          appId: "1:938865791588:web:9385747e23eb18a5a58571"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        console.log('üî• Firebase initialized successfully!');
        
        // ============================================
        // INTERNATIONALIZATION (i18n) SYSTEM
        // ============================================
        
        const translations = {
            en: {
                header: {
                    title: "‚öîÔ∏è ALLIANCE DUEL LEADERBOARD ‚öîÔ∏è",
                    alliance: "[pWR] POWEr Alliance",
                    event: "Weekly Alliance Duel Event"
                },
                buttons: {
                    upload: "üì§ Upload Week Data",
                    signIn: "üîê Sign In",
                    signOut: "üîì Sign Out",
                    refresh: "üîÑ Refresh Data",
                    deleteWeek: "üóëÔ∏è Delete Week",
                    addPlayer: "‚ûï Add Player",
                    exportPdf: "üìÑ Export PDF",
                    exportCsv: "üíæ Export CSV",
                    screenshot: "üì∏ Screenshot",
                    view: "View",
                    edit: "‚úèÔ∏è Edit",
                    delete: "üóëÔ∏è Del"
                },
                table: {
                    rank: "Rank",
                    movement: "Movement",
                    playerName: "Player Name",
                    points: "Points",
                    achievements: "Achievements",
                    division: "Division",
                    actions: "Actions"
                },
                kpi: {
                    totalPlayers: "Total Survivors",
                    avgPoints: "Average Points",
                    topScore: "Top Score",
                    totalPoints: "Total Points"
                },
                movement: {
                    title: "üìà Weekly Movement Highlights",
                    climber: "Biggest Climber",
                    faller: "Biggest Drop",
                    mvp: "Weekly MVP",
                    streak: "Top Streak"
                },
                charts: {
                    top10: "üèÜ Top 10 Champions",
                    distribution: "üìä Score Distribution",
                    topPerformance: "üî• Top 20 Performance",
                    bottomPerformance: "üìâ Bottom 20 Performance"
                },
                divisions: {
                    title: "üèÜ Division Rankings",
                    elite: "Elite Division",
                    master: "Master Division",
                    warrior: "Warrior Division",
                    players: "Players"
                },
                leaderboard: {
                    title: "üìã COMPLETE SURVIVOR RANKINGS",
                    searchPlaceholder: "Search player name..."
                },
                modals: {
                    editPlayer: "‚úèÔ∏è EDIT PLAYER",
                    addPlayer: "‚ûï ADD NEW PLAYER",
                    playerName: "Player Name:",
                    rank: "Rank:",
                    points: "Points:",
                    save: "üíæ SAVE CHANGES",
                    add: "‚ûï ADD PLAYER",
                    cancel: "‚úñ Cancel"
                },
                messages: {
                    signInRequired: "‚ùå Please sign in to upload data",
                    deleteConfirm: "Are you sure you want to delete",
                    uploadSuccess: "‚úÖ Week {week} uploaded successfully!",
                    deleteSuccess: "‚úÖ Player deleted successfully",
                    saveSuccess: "‚úÖ Changes saved successfully!",
                    error: "‚ùå Error"
                },
                week: "Week"
            },
            ar: {
                header: {
                    title: "‚öîÔ∏è ŸÑŸàÿ≠ÿ© ÿµÿØÿßÿ±ÿ© ŸÖÿ®ÿßÿ±ÿ≤ÿ© ÿßŸÑÿ™ÿ≠ÿßŸÑŸÅ ‚öîÔ∏è",
                    alliance: "ÿ™ÿ≠ÿßŸÑŸÅ [pWR] POWEr",
                    event: "ÿ≠ÿØÿ´ ÿßŸÑŸÖÿ®ÿßÿ±ÿ≤ÿ© ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ© ŸÑŸÑÿ™ÿ≠ÿßŸÑŸÅ"
                },
                buttons: {
                    upload: "üì§ ÿ±ŸÅÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ",
                    signIn: "üîê ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
                    signOut: "üîì ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨",
                    refresh: "üîÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                    deleteWeek: "üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ",
                    addPlayer: "‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÑÿßÿπÿ®",
                    exportPdf: "üìÑ ÿ™ÿµÿØŸäÿ± PDF",
                    exportCsv: "üíæ ÿ™ÿµÿØŸäÿ± CSV",
                    screenshot: "üì∏ ŸÑŸÇÿ∑ÿ© ÿ¥ÿßÿ¥ÿ©",
                    view: "ÿπÿ±ÿ∂",
                    edit: "‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ",
                    delete: "üóëÔ∏è ÿ≠ÿ∞ŸÅ"
                },
                table: {
                    rank: "ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ®",
                    movement: "ÿßŸÑÿ≠ÿ±ŸÉÿ©",
                    playerName: "ÿßÿ≥ŸÖ ÿßŸÑŸÑÿßÿπÿ®",
                    points: "ÿßŸÑŸÜŸÇÿßÿ∑",
                    achievements: "ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤ÿßÿ™",
                    division: "ÿßŸÑŸÅÿ¶ÿ©",
                    actions: "ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™"
                },
                kpi: {
                    totalPlayers: "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÜÿßÿ¨ŸäŸÜ",
                    avgPoints: "ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸÜŸÇÿßÿ∑",
                    topScore: "ÿ£ÿπŸÑŸâ ŸÜÿ™Ÿäÿ¨ÿ©",
                    totalPoints: "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÜŸÇÿßÿ∑"
                },
                movement: {
                    title: "üìà ÿ£ÿ®ÿ±ÿ≤ ÿßŸÑÿ™ÿ≠ÿ±ŸÉÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©",
                    climber: "ÿ£ŸÉÿ®ÿ± ÿµÿπŸàÿØ",
                    faller: "ÿ£ŸÉÿ®ÿ± Ÿáÿ®Ÿàÿ∑",
                    mvp: "ÿ£ŸÅÿ∂ŸÑ ŸÑÿßÿπÿ®",
                    streak: "ÿ£ÿ∑ŸàŸÑ ÿ≥ŸÑÿ≥ŸÑÿ©"
                },
                charts: {
                    top10: "üèÜ ÿ£ŸÅÿ∂ŸÑ 10 ÿ£ÿ®ÿ∑ÿßŸÑ",
                    distribution: "üìä ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÜŸÇÿßÿ∑",
                    topPerformance: "üî• ÿ£ÿØÿßÿ° ÿ£ŸÅÿ∂ŸÑ 20",
                    bottomPerformance: "üìâ ÿ£ÿØÿßÿ° ÿ£ÿ≥ŸÅŸÑ 20"
                },
                divisions: {
                    title: "üèÜ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÅÿ¶ÿßÿ™",
                    elite: "ŸÅÿ¶ÿ© ÿßŸÑŸÜÿÆÿ®ÿ©",
                    master: "ŸÅÿ¶ÿ© ÿßŸÑŸÖÿßÿ≥ÿ™ÿ±ÿ≤",
                    warrior: "ŸÅÿ¶ÿ© ÿßŸÑŸÖÿ≠ÿßÿ±ÿ®ŸäŸÜ",
                    players: "ŸÑÿßÿπÿ®ŸäŸÜ"
                },
                leaderboard: {
                    title: "üìã ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÜÿßÿ¨ŸäŸÜ ÿßŸÑŸÉÿßŸÖŸÑ",
                    searchPlaceholder: "ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿßÿ≥ŸÖ ÿßŸÑŸÑÿßÿπÿ®..."
                },
                modals: {
                    editPlayer: "‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÑÿßÿπÿ®",
                    addPlayer: "‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÑÿßÿπÿ® ÿ¨ÿØŸäÿØ",
                    playerName: "ÿßÿ≥ŸÖ ÿßŸÑŸÑÿßÿπÿ®:",
                    rank: "ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ®:",
                    points: "ÿßŸÑŸÜŸÇÿßÿ∑:",
                    save: "üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™",
                    add: "‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÑÿßÿπÿ®",
                    cancel: "‚úñ ÿ•ŸÑÿ∫ÿßÿ°"
                },
                messages: {
                    signInRequired: "‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                    deleteConfirm: "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ",
                    uploadSuccess: "‚úÖ ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ {week} ÿ®ŸÜÿ¨ÿßÿ≠!",
                    deleteSuccess: "‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÑÿßÿπÿ® ÿ®ŸÜÿ¨ÿßÿ≠",
                    saveSuccess: "‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!",
                    error: "‚ùå ÿÆÿ∑ÿ£"
                },
                week: "ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ"
            }
        };
        
        let currentLanguage = localStorage.getItem('dashboardLanguage') || 'en';
        
        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('dashboardLanguage', lang);
            
            // Update HTML direction
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.lang = lang;
            
            // Update language toggle button
            const toggleBtn = document.getElementById('languageToggle');
            if (toggleBtn) {
                toggleBtn.textContent = lang === 'en' ? 'üåê ÿßŸÑÿπÿ±ÿ®Ÿäÿ©' : 'üåê English';
            }
            
            // Translate all elements with data-i18n
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                const keys = key.split('.');
                let translation = translations[lang];
                
                for (const k of keys) {
                    translation = translation[k];
                    if (!translation) break;
                }
                
                if (translation) {
                    element.textContent = translation;
                }
            });
            
            // Update dynamic content
            updateDashboard();
        }
        
        function t(key, replacements = {}) {
            const keys = key.split('.');
            let translation = translations[currentLanguage];
            
            for (const k of keys) {
                translation = translation[k];
                if (!translation) return key;
            }
            
            // Replace placeholders
            if (typeof translation === 'string') {
                for (const [placeholder, value] of Object.entries(replacements)) {
                    translation = translation.replace(`{${placeholder}}`, value);
                }
            }
            
            return translation;
        }
        
        // Language toggle button handler
        document.getElementById('languageToggle')?.addEventListener('click', () => {
            setLanguage(currentLanguage === 'en' ? 'ar' : 'en');
        });
        
        // Initialize language on load
        setLanguage(currentLanguage);
        
        // ============================================
        // FIREBASE FUNCTIONS
        // ============================================
        
        // Load week data from Firebase
        async function loadWeekFromFirebase(weekNum) {
            try {
                const snapshot = await database.ref(`weeks/${weekNum}`).once('value');
                const data = snapshot.val();
                
                if (!data) {
                    console.log(`Week ${weekNum} not found in Firebase`);
                    return null;
                }
                
                // Convert Firebase object to array
                const players = Object.values(data).map(player => ({
                    Rank: player.rank,
                    'Player Name': player.playerName,
                    Points: player.points
                }));
                
                weeklyData[weekNum] = players;
                console.log(`‚úÖ Loaded Week ${weekNum} from Firebase (${players.length} players)`);
                return players;
            } catch (error) {
                console.error(`Error loading week ${weekNum}:`, error);
                return null;
            }
        }
        
        // Load all available weeks
        async function loadAllWeeksFromFirebase() {
            try {
                const metaSnapshot = await database.ref('metadata').once('value');
                const metadata = metaSnapshot.val();
                
                const totalWeeks = metadata?.totalWeeks || 0;
                
                if (totalWeeks === 0) {
                    console.log('No weeks found in Firebase');
                    return 0;
                }
                
                // Load all weeks
                for (let i = 1; i <= totalWeeks; i++) {
                    await loadWeekFromFirebase(i);
                }
                
                console.log(`‚úÖ Loaded ${totalWeeks} weeks from Firebase`);
                return totalWeeks;
            } catch (error) {
                console.error('Error loading weeks from Firebase:', error);
                return 0;
            }
        }
        
        // Save week data to Firebase
        async function saveWeekToFirebase(weekNum, csvData) {
            try {
                if (!auth.currentUser) {
                    throw new Error('You must be signed in to upload data');
                }
                
                const players = parseCSV(csvData);
                if (!players || players.length === 0) {
                    throw new Error('Invalid CSV data');
                }
                
                console.log(`Uploading Week ${weekNum} to Firebase (${players.length} players)...`);
                
                // Convert to Firebase format
                const firebaseData = players.map(p => ({
                    rank: p.Rank,
                    playerName: p['Player Name'],
                    points: p.Points
                }));
                
                // Save to Firebase
                await database.ref(`weeks/${weekNum}`).set(firebaseData);
                
                // Update metadata
                const metaSnapshot = await database.ref('metadata').once('value');
                const currentMeta = metaSnapshot.val() || {};
                
                await database.ref('metadata').set({
                    totalWeeks: Math.max(currentMeta.totalWeeks || 0, weekNum),
                    latestWeek: weekNum,
                    lastUpdated: new Date().toISOString(),
                    uploadedBy: auth.currentUser.email
                });
                
                // Reload data locally
                await loadWeekFromFirebase(weekNum);
                
                console.log(`‚úÖ Week ${weekNum} uploaded successfully`);
                return true;
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                throw error;
            }
        }
        
        // Authentication functions
        async function signInToFirebase(email, password) {
            try {
                await auth.signInWithEmailAndPassword(email, password);
                console.log('‚úÖ Signed in successfully');
                return true;
            } catch (error) {
                console.error('Sign in error:', error);
                throw error;
            }
        }
        
        function signOutFromFirebase() {
            auth.signOut();
            console.log('‚úÖ Signed out');
        }
        
        // Show loading state
        function showFirebaseLoading() {
            const kpiGrid = document.getElementById('kpiGrid');
            if (kpiGrid) {
                kpiGrid.innerHTML = `
                    <div class="kpi-card" style="grid-column: 1 / -1;">
                        <div class="kpi-label">üî• LOADING FROM FIREBASE...</div>
                        <div class="kpi-value">‚è≥</div>
                        <div class="kpi-subtext">Fetching alliance data...</div>
                    </div>
                `;
            }
        }
        
        // ============================================
        // === DATA MANAGEMENT ===
        let weeklyData = {};
        let currentWeek = 1;
        let chartInstances = {};
        let playerHistory = {}; // Track each player across weeks

        // === UTILITY FUNCTIONS ===
        function parseCSV(csv) {
            // Normalize line endings (handle \r\n, \r, and \n)
            const normalizedCSV = csv.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            const lines = normalizedCSV.trim().split('\n');
            console.log('parseCSV: Total lines:', lines.length);
            
            if (lines.length === 0) return [];
            
            // Get headers from first line
            const headerLine = lines[0];
            const headers = parseCSVLine(headerLine).map(h => h.trim());
            console.log('parseCSV: Headers:', headers);
            
            // Parse data rows
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue; // Skip empty lines
                
                const values = parseCSVLine(lines[i]);
                const obj = {};
                
                headers.forEach((header, index) => {
                    let value = (values[index] || '').trim();
                    
                    // Handle Points column - remove commas and convert to number
                    if (header === 'Points') {
                        obj[header] = parseInt(value.replace(/,/g, '')) || 0;
                    } 
                    // Handle Rank column - convert to number
                    else if (header === 'Rank') {
                        obj[header] = parseInt(value) || 0;
                    } 
                    // All other columns - keep as string
                    else {
                        obj[header] = value;
                    }
                });
                
                // Only add if we have valid data
                if (obj['Player Name'] && obj.Rank && obj.Points) {
                    data.push(obj);
                } else {
                    console.log('parseCSV: Skipping invalid row:', obj);
                }
            }
            
            console.log('parseCSV: Parsed', data.length, 'valid rows');
            return data;
        }

        // Helper function to parse a single CSV line
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Handle escaped quotes
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote state
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // Found field separator
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // Add last field
            result.push(current);
            
            return result;
        }

        function getCurrentPlayers() {
            return weeklyData[currentWeek] || [];
        }

        function destroyChart(chartId) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
                delete chartInstances[chartId];
            }
        }

        function getDivision(points) {
            if (points > 100000000) return 'Elite';
            if (points >= 50000000) return 'Master';
            return 'Warrior';
        }

        function getAchievements(player, week) {
            const achievements = [];
            const rank = player.Rank;
            const points = player.Points;
            
            if (rank === 1) achievements.push('üëë Champion');
            if (rank <= 3) achievements.push('ü•á Top 3');
            if (rank <= 10) achievements.push('‚≠ê Top 10');
            if (points > 100000000) achievements.push('üíé 100M Club');
            if (points > 200000000) achievements.push('üèÜ 200M Club');
            
            return achievements;
        }

        function calculateMovement(playerName) {
            const weeks = Object.keys(weeklyData).sort((a, b) => a - b);
            if (weeks.length < 2 || currentWeek == 1) return { change: 0, type: 'same' };
            
            const currentIndex = weeks.indexOf(currentWeek.toString());
            if (currentIndex === 0) return { change: 0, type: 'same' };
            
            const prevWeek = weeks[currentIndex - 1];
            const currentData = weeklyData[currentWeek].find(p => p['Player Name'] === playerName);
            const prevData = weeklyData[prevWeek].find(p => p['Player Name'] === playerName);
            
            if (!currentData || !prevData) return { change: 0, type: 'same' };
            
            const change = prevData.Rank - currentData.Rank;
            const type = change > 0 ? 'up' : change < 0 ? 'down' : 'same';
            
            return { change: Math.abs(change), type };
        }

        // === RENDERING FUNCTIONS ===
        function renderKPIs() {
            const players = getCurrentPlayers();
            if (!players.length) return;
            
            const totalPlayers = players.length;
            const totalPoints = players.reduce((sum, p) => sum + p.Points, 0);
            const avgScore = Math.round(totalPoints / totalPlayers);
            const highestScore = Math.max(...players.map(p => p.Points));
            const lowestScore = Math.min(...players.map(p => p.Points));
            const champion = players.find(p => p.Points === highestScore);
            
            document.getElementById('kpiGrid').innerHTML = `
                <div class="kpi-card">
                    <div class="kpi-label">Total Players</div>
                    <div class="kpi-value">${totalPlayers}</div>
                    <div class="kpi-subtext">Active Warriors</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Average Score</div>
                    <div class="kpi-value">${avgScore.toLocaleString()}</div>
                    <div class="kpi-subtext">Points per Player</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Champion</div>
                    <div class="kpi-value">${highestScore.toLocaleString()}</div>
                    <div class="kpi-subtext">${champion['Player Name']}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Lowest Score</div>
                    <div class="kpi-value">${lowestScore.toLocaleString()}</div>
                    <div class="kpi-subtext">Entry Level</div>
                </div>
            `;
        }

        function renderMovementHighlights() {
            const weeks = Object.keys(weeklyData).sort((a, b) => a - b);
            if (weeks.length < 2 || currentWeek == 1) {
                document.getElementById('movementSection').style.display = 'none';
                return;
            }
            
            document.getElementById('movementSection').style.display = 'block';
            
            const currentIndex = weeks.indexOf(currentWeek.toString());
            const prevWeek = weeks[currentIndex - 1];
            const currentData = weeklyData[currentWeek];
            const prevData = weeklyData[prevWeek];
            
            // Calculate movements
            const movements = currentData.map(p => {
                const prev = prevData.find(pp => pp['Player Name'] === p['Player Name']);
                if (!prev) return null;
                return {
                    name: p['Player Name'],
                    rankChange: prev.Rank - p.Rank,
                    pointsGain: p.Points - prev.Points
                };
            }).filter(m => m !== null);
            
            const biggestClimber = movements.reduce((max, m) => m.rankChange > max.rankChange ? m : max, movements[0]);
            const biggestFaller = movements.reduce((min, m) => m.rankChange < min.rankChange ? m : min, movements[0]);
            const mvp = movements.reduce((max, m) => m.pointsGain > max.pointsGain ? m : max, movements[0]);
            
            document.getElementById('biggestClimber').textContent = biggestClimber?.name || '-';
            document.getElementById('climberStats').textContent = `‚Üë ${biggestClimber?.rankChange || 0} positions`;
            
            document.getElementById('biggestFaller').textContent = biggestFaller?.name || '-';
            document.getElementById('fallerStats').textContent = `‚Üì ${Math.abs(biggestFaller?.rankChange || 0)} positions`;
            
            document.getElementById('weeklyMvp').textContent = mvp?.name || '-';
            document.getElementById('mvpStats').textContent = `+${(mvp?.pointsGain || 0).toLocaleString()} points`;
            
            // Top streak (simplified - player in top 10 for longest)
            document.getElementById('topStreak').textContent = currentData[0]['Player Name'];
            document.getElementById('streakStats').textContent = `${weeks.length} weeks tracked`;
        }

        function renderCharts() {
            const players = getCurrentPlayers();
            if (!players.length) return;
            
            // Top 10 Bar Chart
            const top10 = players.slice(0, 10);
            const barCtx = document.getElementById('barChart').getContext('2d');
            destroyChart('barChart');
            chartInstances['barChart'] = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: top10.map(p => p['Player Name']),
                    datasets: [{
                        label: 'Points',
                        data: top10.map(p => p.Points),
                        backgroundColor: 'rgba(139, 69, 255, 0.8)',
                        borderColor: 'rgba(139, 69, 255, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(139, 69, 255, 0.1)' },
                            ticks: {
                                color: '#b0b0b0',
                                callback: v => (v / 1000000).toFixed(0) + 'M'
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#b0b0b0', maxRotation: 45 }
                        }
                    }
                }
            });
            
            // Pie Chart
            const tiers = {
                'Elite (>100M)': players.filter(p => p.Points > 100000000).length,
                'Master (50M-100M)': players.filter(p => p.Points >= 50000000 && p.Points <= 100000000).length,
                'Warrior (<50M)': players.filter(p => p.Points < 50000000).length
            };
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            destroyChart('pieChart');
            chartInstances['pieChart'] = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(tiers),
                    datasets: [{
                        data: Object.values(tiers),
                        backgroundColor: ['rgba(255, 215, 0, 0.8)', 'rgba(139, 69, 255, 0.8)', 'rgba(255, 0, 128, 0.8)'],
                        borderColor: ['rgba(255, 215, 0, 1)', 'rgba(139, 69, 255, 1)', 'rgba(255, 0, 128, 1)'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#b0b0b0', font: { size: 14 }, padding: 20 }
                        }
                    }
                }
            });
            
            // Top 20 Performance
            const top20 = players.slice(0, 20);
            const topPerfCtx = document.getElementById('topPerformanceChart').getContext('2d');
            destroyChart('topPerformanceChart');
            chartInstances['topPerformanceChart'] = new Chart(topPerfCtx, {
                type: 'line',
                data: {
                    labels: top20.map(p => p['Player Name']),
                    datasets: [{
                        label: 'Points',
                        data: top20.map(p => p.Points),
                        borderColor: 'rgba(139, 69, 255, 1)',
                        backgroundColor: 'rgba(139, 69, 255, 0.2)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            grid: { color: 'rgba(139, 69, 255, 0.1)' },
                            ticks: {
                                color: '#b0b0b0',
                                callback: v => (v / 1000000).toFixed(0) + 'M'
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#b0b0b0', maxRotation: 45 }
                        }
                    }
                }
            });
            
            // Bottom 20 Performance
            const bottom20 = players.slice(-20).reverse();
            const bottomPerfCtx = document.getElementById('bottomPerformanceChart').getContext('2d');
            destroyChart('bottomPerformanceChart');
            chartInstances['bottomPerformanceChart'] = new Chart(bottomPerfCtx, {
                type: 'line',
                data: {
                    labels: bottom20.map(p => p['Player Name']),
                    datasets: [{
                        label: 'Points',
                        data: bottom20.map(p => p.Points),
                        borderColor: 'rgba(255, 0, 128, 1)',
                        backgroundColor: 'rgba(255, 0, 128, 0.2)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 0, 128, 0.1)' },
                            ticks: {
                                color: '#b0b0b0',
                                callback: v => (v / 1000000).toFixed(0) + 'M'
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#b0b0b0', maxRotation: 45 }
                        }
                    }
                }
            });
        }

        function renderDivisions() {
            const players = getCurrentPlayers();
            const elite = players.filter(p => p.Points > 100000000);
            const master = players.filter(p => p.Points >= 50000000 && p.Points <= 100000000);
            const warrior = players.filter(p => p.Points < 50000000);
            
            document.getElementById('eliteDivisionCount').textContent = `${elite.length} Players`;
            document.getElementById('eliteDivisionPlayers').innerHTML = elite.slice(0, 5).map(p => p['Player Name']).join(', ') + (elite.length > 5 ? '...' : '');
            
            document.getElementById('masterDivisionCount').textContent = `${master.length} Players`;
            document.getElementById('masterDivisionPlayers').innerHTML = master.slice(0, 5).map(p => p['Player Name']).join(', ') + (master.length > 5 ? '...' : '');
            
            document.getElementById('warriorDivisionCount').textContent = `${warrior.length} Players`;
            document.getElementById('warriorDivisionPlayers').innerHTML = warrior.slice(0, 5).map(p => p['Player Name']).join(', ') + (warrior.length > 5 ? '...' : '');
        }

        function renderTable(data = null) {
            const players = data || getCurrentPlayers();
            const tbody = document.getElementById('tableBody');
            const isAdmin = auth.currentUser !== null;
            
            tbody.innerHTML = players.map(player => {
                let rankClass = 'rank-default';
                if (player.Rank === 1) rankClass = 'rank-1';
                else if (player.Rank === 2) rankClass = 'rank-2';
                else if (player.Rank === 3) rankClass = 'rank-3';
                else if (player.Rank <= 10) rankClass = 'rank-top10';
                
                const movement = calculateMovement(player['Player Name']);
                const movementIcon = movement.type === 'up' ? '‚Üë' : movement.type === 'down' ? '‚Üì' : '‚îÄ';
                const movementText = movement.change > 0 ? `${movementIcon} ${movement.change}` : movementIcon;
                
                const achievements = getAchievements(player, currentWeek);
                const division = getDivision(player.Points);
                
                // Admin buttons (only show if signed in)
                const adminButtons = isAdmin ? `
                    <button class="view-profile-btn" onclick="editPlayer('${player['Player Name'].replace(/'/g, "\\'")}', ${player.Rank})" style="background: rgba(153, 204, 51, 0.4); border-color: #99cc33;">${t('buttons.edit')}</button>
                    <button class="view-profile-btn" onclick="deletePlayer('${player['Player Name'].replace(/'/g, "\\'")}', ${player.Rank})" style="background: rgba(204, 51, 0, 0.4); border-color: #cc3300;">${t('buttons.delete')}</button>
                ` : '';
                
                return `
                    <tr>
                        <td><span class="rank-badge ${rankClass}">#${player.Rank}</span></td>
                        <td><span class="rank-movement ${movement.type}">${movementText}</span></td>
                        <td>${player['Player Name']}</td>
                        <td>${player.Points.toLocaleString()}</td>
                        <td>${achievements.map(a => `<span class="achievement-badge">${a}</span>`).join('')}</td>
                        <td>${division}</td>
                        <td>
                            <button class="view-profile-btn" onclick="openPlayerProfile('${player['Player Name'].replace(/'/g, "\\'")}')">  ${t('buttons.view')}</button>
                            ${adminButtons}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateWeekButtons() {
            const weeks = Object.keys(weeklyData).sort((a, b) => a - b);
            const weekSelector = document.getElementById('weekSelector');
            
            weekSelector.innerHTML = weeks.map(week => 
                `<button class="week-btn ${week == currentWeek ? 'active' : ''}" onclick="selectWeek(${week})">${t('week')} ${week}</button>`
            ).join('');
        }

        function updateDashboard() {
            renderKPIs();
            renderMovementHighlights();
            renderCharts();
            renderDivisions();
            renderTable();
            document.getElementById('searchBar').value = '';
        }

        // === USER INTERACTIONS ===
        function selectWeek(week) {
            currentWeek = week;
            updateWeekButtons();
            updateDashboard();
        }

        function openPlayerProfile(playerName) {
            const weeks = Object.keys(weeklyData).sort((a, b) => a - b);
            const playerData = getCurrentPlayers().find(p => p['Player Name'] === playerName);
            
            if (!playerData) return;
            
            document.getElementById('modalPlayerName').textContent = playerName;
            document.getElementById('modalRank').textContent = `#${playerData.Rank}`;
            document.getElementById('modalPoints').textContent = playerData.Points.toLocaleString();
            document.getElementById('modalDivision').textContent = getDivision(playerData.Points);
            
            // Player history chart
            const historyData = weeks.map(week => {
                const data = weeklyData[week].find(p => p['Player Name'] === playerName);
                return data ? data.Points : 0;
            });
            
            const histCtx = document.getElementById('playerHistoryChart').getContext('2d');
            if (chartInstances['playerHistoryChart']) {
                chartInstances['playerHistoryChart'].destroy();
            }
            chartInstances['playerHistoryChart'] = new Chart(histCtx, {
                type: 'line',
                data: {
                    labels: weeks.map(w => `Week ${w}`),
                    datasets: [{
                        label: 'Points',
                        data: historyData,
                        borderColor: 'rgba(139, 69, 255, 1)',
                        backgroundColor: 'rgba(139, 69, 255, 0.2)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            grid: { color: 'rgba(139, 69, 255, 0.1)' },
                            ticks: { color: '#b0b0b0' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#b0b0b0' }
                        }
                    }
                }
            });
            
            document.getElementById('playerModal').style.display = 'block';
        }

        // CSV Upload
        document.getElementById('csvUpload').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Check authentication first
            if (!auth.currentUser) {
                alert('‚ùå Please sign in first to upload data');
                e.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const csvContent = event.target.result;
                    console.log('CSV Content loaded, length:', csvContent.length);
                    
                    const newPlayers = parseCSV(csvContent);
                    console.log('Parsed players:', newPlayers.length, newPlayers.slice(0, 3));
                    
                    if (!newPlayers || newPlayers.length === 0) {
                        alert('‚ùå No valid data found in CSV. Please check the file format.\n\nExpected format:\nRank,Player Name,Points\n1,Name,"1,000,000"');
                        e.target.value = '';
                        return;
                    }
                    
                    const existingWeeks = Object.keys(weeklyData).map(Number);
                    const nextWeek = existingWeeks.length > 0 ? Math.max(...existingWeeks) + 1 : 1;
                    
                    console.log(`Uploading Week ${nextWeek} with ${newPlayers.length} players...`);
                    
                    // Save to Firebase
                    await saveWeekToFirebase(nextWeek, csvContent);
                    
                    // Update UI
                    currentWeek = nextWeek;
                    updateWeekButtons();
                    updateDashboard();
                    
                    alert(`‚úÖ Week ${nextWeek} uploaded successfully to Firebase!\n${newPlayers.length} players uploaded.`);
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    alert(`‚ùå Error uploading CSV: ${error.message}\n\nCheck browser console (F12) for details.`);
                }
            };
            
            reader.onerror = function() {
                alert('‚ùå Error reading file. Please try again.');
            };
            
            reader.readAsText(file);
            e.target.value = '';
        });

        // Export Functions
        document.getElementById('exportPdfBtn').addEventListener('click', () => {
            alert('üìÑ PDF export feature - Would use jsPDF library to generate PDF report of current week data');
        });

        document.getElementById('exportCsvBtn').addEventListener('click', () => {
            const players = getCurrentPlayers();
            const csv = 'Rank,Player Name,Points\n' + players.map(p => 
                `${p.Rank},"${p['Player Name']}","${p.Points.toLocaleString()}"`
            ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pwr_alliance_week${currentWeek}.csv`;
            a.click();
        });

        document.getElementById('shareBtn').addEventListener('click', () => {
            html2canvas(document.querySelector('.dashboard-container')).then(canvas => {
                const link = document.createElement('a');
                link.download = `pwr_alliance_week${currentWeek}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        });

        // Search
        document.getElementById('searchBar').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const players = getCurrentPlayers();
            const filtered = players.filter(p => 
                p['Player Name'].toLowerCase().includes(searchTerm)
            );
            renderTable(filtered);
        });

        // Modal Close
        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('playerModal').style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target.id === 'playerModal') {
                document.getElementById('playerModal').style.display = 'none';
            }
        });

        // ============================================
        // === EDIT/DELETE/ADD PLAYER FUNCTIONS ===
        // ============================================
        
        // Edit Player
        function editPlayer(playerName, rank) {
            if (!auth.currentUser) {
                alert('‚ùå Please sign in to edit players');
                return;
            }
            
            const players = getCurrentPlayers();
            const player = players.find(p => p['Player Name'] === playerName && p.Rank === rank);
            
            if (!player) {
                alert('‚ùå Player not found');
                return;
            }
            
            // Populate modal
            document.getElementById('editPlayerOriginalName').value = playerName;
            document.getElementById('editPlayerOriginalRank').value = rank;
            document.getElementById('editPlayerName').value = playerName;
            document.getElementById('editPlayerRank').value = rank;
            document.getElementById('editPlayerPoints').value = player.Points;
            document.getElementById('editPlayerStatus').textContent = '';
            
            // Show modal
            document.getElementById('editPlayerModal').style.display = 'block';
        }
        
        // Save Edited Player
        async function saveEditedPlayer() {
            const statusDiv = document.getElementById('editPlayerStatus');
            
            try {
                const originalName = document.getElementById('editPlayerOriginalName').value;
                const originalRank = parseInt(document.getElementById('editPlayerOriginalRank').value);
                const newName = document.getElementById('editPlayerName').value.trim();
                const newRank = parseInt(document.getElementById('editPlayerRank').value);
                const newPoints = parseInt(document.getElementById('editPlayerPoints').value.replace(/,/g, ''));
                
                if (!newName || !newRank || !newPoints) {
                    statusDiv.textContent = '‚ö†Ô∏è All fields are required';
                    return;
                }
                
                if (newPoints <= 0) {
                    statusDiv.textContent = '‚ö†Ô∏è Points must be greater than 0';
                    return;
                }
                
                statusDiv.textContent = '‚è≥ Saving...';
                
                // Get current week data
                const players = getCurrentPlayers();
                
                // Find and update the player
                const playerIndex = players.findIndex(p => 
                    p['Player Name'] === originalName && p.Rank === originalRank
                );
                
                if (playerIndex === -1) {
                    throw new Error('Player not found');
                }
                
                // Update player data
                players[playerIndex] = {
                    Rank: newRank,
                    'Player Name': newName,
                    Points: newPoints
                };
                
                // Sort by rank
                players.sort((a, b) => a.Rank - b.Rank);
                
                // Convert to CSV format
                const csvContent = 'Rank,Player Name,Points\n' + 
                    players.map(p => `${p.Rank},"${p['Player Name']}","${p.Points}"`).join('\n');
                
                // Save to Firebase (this will overwrite the week)
                await saveWeekToFirebase(currentWeek, csvContent);
                
                // Update local data
                weeklyData[currentWeek] = players;
                
                // Refresh UI
                updateDashboard();
                
                statusDiv.textContent = '‚úÖ Player updated successfully!';
                
                setTimeout(() => {
                    document.getElementById('editPlayerModal').style.display = 'none';
                }, 1500);
                
            } catch (error) {
                console.error('Error saving player:', error);
                statusDiv.textContent = `‚ùå ${error.message}`;
            }
        }
        
        // Delete Player
        async function deletePlayer(playerName, rank) {
            if (!auth.currentUser) {
                alert('‚ùå Please sign in to delete players');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete "${playerName}" (Rank #${rank}) from Week ${currentWeek}?\n\nThis action cannot be undone!`)) {
                return;
            }
            
            try {
                // Get current week data
                const players = getCurrentPlayers();
                
                // Remove the player
                const filteredPlayers = players.filter(p => 
                    !(p['Player Name'] === playerName && p.Rank === rank)
                );
                
                if (filteredPlayers.length === players.length) {
                    alert('‚ùå Player not found');
                    return;
                }
                
                // Re-assign ranks
                filteredPlayers.forEach((p, index) => {
                    p.Rank = index + 1;
                });
                
                // Convert to CSV format
                const csvContent = 'Rank,Player Name,Points\n' + 
                    filteredPlayers.map(p => `${p.Rank},"${p['Player Name']}","${p.Points}"`).join('\n');
                
                // Save to Firebase
                await saveWeekToFirebase(currentWeek, csvContent);
                
                // Update local data
                weeklyData[currentWeek] = filteredPlayers;
                
                // Refresh UI
                updateDashboard();
                
                alert(`‚úÖ "${playerName}" has been deleted from Week ${currentWeek}`);
                
            } catch (error) {
                console.error('Error deleting player:', error);
                alert(`‚ùå Error deleting player: ${error.message}`);
            }
        }
        
        // Show Add Player Modal
        function showAddPlayerModal() {
            if (!auth.currentUser) {
                alert('‚ùå Please sign in to add players');
                return;
            }
            
            document.getElementById('addPlayerName').value = '';
            document.getElementById('addPlayerRank').value = '';
            document.getElementById('addPlayerPoints').value = '';
            document.getElementById('addPlayerStatus').textContent = '';
            
            document.getElementById('addPlayerModal').style.display = 'block';
        }
        
        // Save New Player
        async function saveNewPlayer() {
            const statusDiv = document.getElementById('addPlayerStatus');
            
            try {
                const newName = document.getElementById('addPlayerName').value.trim();
                const newRank = parseInt(document.getElementById('addPlayerRank').value);
                const newPoints = parseInt(document.getElementById('addPlayerPoints').value.replace(/,/g, ''));
                
                if (!newName || !newRank || !newPoints) {
                    statusDiv.textContent = '‚ö†Ô∏è All fields are required';
                    return;
                }
                
                if (newPoints <= 0) {
                    statusDiv.textContent = '‚ö†Ô∏è Points must be greater than 0';
                    return;
                }
                
                statusDiv.textContent = '‚è≥ Adding player...';
                
                // Get current week data
                const players = getCurrentPlayers();
                
                // Add new player
                players.push({
                    Rank: newRank,
                    'Player Name': newName,
                    Points: newPoints
                });
                
                // Sort by rank
                players.sort((a, b) => a.Rank - b.Rank);
                
                // Re-assign ranks to ensure no gaps
                players.forEach((p, index) => {
                    p.Rank = index + 1;
                });
                
                // Convert to CSV format
                const csvContent = 'Rank,Player Name,Points\n' + 
                    players.map(p => `${p.Rank},"${p['Player Name']}","${p.Points}"`).join('\n');
                
                // Save to Firebase
                await saveWeekToFirebase(currentWeek, csvContent);
                
                // Update local data
                weeklyData[currentWeek] = players;
                
                // Refresh UI
                updateDashboard();
                
                statusDiv.textContent = '‚úÖ Player added successfully!';
                
                setTimeout(() => {
                    document.getElementById('addPlayerModal').style.display = 'none';
                }, 1500);
                
            } catch (error) {
                console.error('Error adding player:', error);
                statusDiv.textContent = `‚ùå ${error.message}`;
            }
        }
        
        // Delete Week
        async function deleteCurrentWeek() {
            if (!auth.currentUser) {
                alert('‚ùå Please sign in to delete weeks');
                return;
            }
            
            if (Object.keys(weeklyData).length === 1) {
                alert('‚ùå Cannot delete the only week! You must have at least one week of data.');
                return;
            }
            
            const confirmText = prompt(
                `‚ö†Ô∏è WARNING: You are about to delete Week ${currentWeek} permanently!\n\n` +
                `This will remove all ${getCurrentPlayers().length} players from Week ${currentWeek}.\n\n` +
                `Type "DELETE" to confirm:`
            );
            
            if (confirmText !== 'DELETE') {
                alert('Deletion cancelled');
                return;
            }
            
            try {
                // Delete from Firebase
                await database.ref(`weeks/${currentWeek}`).remove();
                
                // Update metadata
                delete weeklyData[currentWeek];
                const weeks = Object.keys(weeklyData).map(Number);
                const newTotalWeeks = Math.max(...weeks);
                const newLatestWeek = newTotalWeeks;
                
                await database.ref('metadata').set({
                    totalWeeks: weeks.length,
                    latestWeek: newLatestWeek,
                    lastUpdated: new Date().toISOString(),
                    uploadedBy: auth.currentUser.email
                });
                
                // Switch to another week
                currentWeek = newLatestWeek;
                
                // Refresh UI
                updateWeekButtons();
                updateDashboard();
                
                alert(`‚úÖ Week ${currentWeek} has been deleted`);
                
            } catch (error) {
                console.error('Error deleting week:', error);
                alert(`‚ùå Error deleting week: ${error.message}`);
            }
        }
        
        // Refresh Data from Firebase
        async function refreshDataFromFirebase() {
            try {
                const refreshBtn = document.getElementById('refreshDataBtn');
                if (refreshBtn) {
                    refreshBtn.textContent = '‚è≥ Refreshing...';
                    refreshBtn.disabled = true;
                }
                
                showFirebaseLoading();
                
                // Clear local data
                weeklyData = {};
                
                // Reload from Firebase
                const totalWeeks = await loadAllWeeksFromFirebase();
                
                if (totalWeeks > 0) {
                    currentWeek = totalWeeks;
                }
                
                // Refresh UI
                updateWeekButtons();
                updateDashboard();
                
                alert(`‚úÖ Data refreshed! Loaded ${totalWeeks} weeks from Firebase.`);
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                alert(`‚ùå Error refreshing data: ${error.message}`);
            } finally {
                const refreshBtn = document.getElementById('refreshDataBtn');
                if (refreshBtn) {
                    refreshBtn.textContent = 'üîÑ Refresh Data';
                    refreshBtn.disabled = false;
                }
            }
        }
        
        // Modal Close Handlers
        document.getElementById('closeEditModal')?.addEventListener('click', () => {
            document.getElementById('editPlayerModal').style.display = 'none';
        });
        
        document.getElementById('closeAddModal')?.addEventListener('click', () => {
            document.getElementById('addPlayerModal').style.display = 'none';
        });
        
        window.addEventListener('click', (e) => {
            if (e.target.id === 'editPlayerModal') {
                document.getElementById('editPlayerModal').style.display = 'none';
            }
            if (e.target.id === 'addPlayerModal') {
                document.getElementById('addPlayerModal').style.display = 'none';
            }
        });
        
        // Save buttons
        document.getElementById('saveEditPlayerBtn')?.addEventListener('click', saveEditedPlayer);
        document.getElementById('saveAddPlayerBtn')?.addEventListener('click', saveNewPlayer);
        
        // Control buttons
        document.getElementById('refreshDataBtn')?.addEventListener('click', refreshDataFromFirebase);

        // ============================================
        // === FIREBASE INITIALIZATION ===
        // ============================================
        
        async function initializeDashboard() {
            console.log('üöÄ Initializing dashboard with Firebase...');
            
            showFirebaseLoading();
            
            // Try to load from Firebase first
            const totalWeeks = await loadAllWeeksFromFirebase();
            
            if (totalWeeks === 0) {
                // No data in Firebase - show empty state
                console.log('‚ö†Ô∏è No Firebase data found. Please upload Week 1 data.');
                
                // Show message to user
                const kpiGrid = document.getElementById('kpiGrid');
                if (kpiGrid) {
                    kpiGrid.innerHTML = `
                        <div class="kpi-card" style="grid-column: 1 / -1;">
                            <div class="kpi-label">üì§ ${t('messages.noData') || 'NO DATA UPLOADED YET'}</div>
                            <div class="kpi-value">‚ö†Ô∏è</div>
                            <div class="kpi-subtext">${t('messages.uploadFirst') || 'Please sign in and upload Week 1 data to get started'}</div>
                        </div>
                    `;
                }
                
                currentWeek = 1;
            } else {
                // Set current week to latest available
                currentWeek = totalWeeks;
                
                // Update UI
                updateWeekButtons();
                updateDashboard();
            }
            
            updateAuthUI();
            console.log('‚úÖ Dashboard initialized');
        }
        
        // Auth state observer
        auth.onAuthStateChanged((user) => {
            console.log('Auth state changed:', user ? `Signed in as ${user.email}` : 'Signed out');
            updateAuthUI();
        });
        
        // Update UI based on auth state
        function updateAuthUI() {
            const user = auth.currentUser;
            const signInBtn = document.getElementById('signInOutBtn');
            const uploadLabel = document.getElementById('uploadBtn');
            const refreshDataBtn = document.getElementById('refreshDataBtn');
            
            if (user) {
                // User is signed in - SHOW admin buttons
                if (signInBtn) {
                    signInBtn.textContent = t('buttons.signOut');
                    signInBtn.title = `Signed in as ${user.email}`;
                }
                if (uploadLabel) {
                    uploadLabel.style.display = 'inline-block';
                    uploadLabel.textContent = t('buttons.upload');
                    uploadLabel.style.background = 'linear-gradient(135deg, #99cc33, #669900)';
                    uploadLabel.style.boxShadow = '0 0 20px rgba(153, 204, 51, 0.4)';
                    uploadLabel.title = `Signed in as ${user.email} - Click to upload`;
                }
                if (refreshDataBtn) {
                    refreshDataBtn.textContent = t('buttons.refresh');
                }
            } else {
                // User is signed out - HIDE admin buttons
                if (signInBtn) {
                    signInBtn.textContent = t('buttons.signIn');
                    signInBtn.title = 'Sign in to manage data';
                }
                if (uploadLabel) {
                    uploadLabel.style.display = 'none';
                }
                if (refreshDataBtn) {
                    refreshDataBtn.textContent = t('buttons.refresh');
                }
            }
        }
        
        // Sign In/Out button handler
        document.getElementById('signInOutBtn').addEventListener('click', async () => {
            const user = auth.currentUser;
            
            if (user) {
                // User is signed in - sign out
                if (confirm(`Sign out from ${user.email}?`)) {
                    signOutFromFirebase();
                    alert('‚úÖ Signed out successfully');
                }
            } else {
                // User is signed out - prompt for sign in
                const email = prompt('Enter your email:', '');
                if (!email) return;
                
                const password = prompt('Enter your password:', '');
                if (!password) return;
                
                try {
                    await signInToFirebase(email, password);
                    alert(`‚úÖ Signed in successfully as ${email}!`);
                } catch (error) {
                    alert(`‚ùå Sign in failed: ${error.message}`);
                }
            }
        });
        
        // Start the app
        initializeDashboard();
    </script>

</body>
</html>
